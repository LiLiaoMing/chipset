#include "StdAfx.h"
#include "RM.h"

CRM::CRM(void)
{
}

CRM::~CRM(void)
{
}

void CRM::SetCardInfo(CString& strTrack2, CString& strFolderName, CString& strAppLabel, BOOL bTrack1Discr, CString strTrack1, CString strAID, CString strCountry, CString strCurrency, CString strArqc1, CString strArqc2, CString strArqc3, CString strPrefName, CString strEffectiveDate, CString strExpirationDate, CString strServiceCode)
{
	m_strTrack2 = strTrack2;
	m_strCardFolderName = strFolderName;
	m_strAppLabel = strAppLabel;
	m_bTrack1Discr = bTrack1Discr;

	m_strTrack1 = strTrack1;
	
	m_strAID = strAID;
	m_strCountry = strCountry;
	m_strCurrency = strCurrency;
	m_strArqc1 = strArqc1;
	m_strArqc2 = strArqc2;
	m_strArqc3 = strArqc3;
	m_strPrefName = strPrefName;
	m_strEffectiveDate = strEffectiveDate;
	m_strExpirationDate = strExpirationDate;
	m_strServiceCode = strServiceCode;
}

void CRM::MakeMasterScript01(CStringArray& sarray, BOOL isGen = FALSE)
{
	CString strTemp = _T("");
	CString strPart1, strPart2;
	int pos;

	//Make AutoRun (APDU command)
	sarray.Add(_T("mode_211"));
	sarray.Add(_T("establish_context"));
	sarray.Add(_T("enable_trace"));
	sarray.Add(_T("enable_timer"));
	sarray.Add(_T("card_connect"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a404000e315041592e5359532e4444463031"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401060100"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40101"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40105"));
	
	strTemp = _T("");
	strTemp.Format(_T("send_apdu -sc 0 -APDU 00a40102414100a4040007a00000000%s336f318407a00000000%sa526500a4d6173746572436172648701015f2d0670746573656e9f1101019f1207%s"), m_strAID, m_strAID, m_strPrefName);
	sarray.Add(strTemp);
		
	strTemp = sarray.GetAt(sarray.GetSize()-1);
	if(!m_strAppLabel.IsEmpty()) {
		ReplaceInfoEx(strTemp, _T("50"), m_strAppLabel);	//Application Label
		sarray.SetAt(sarray.GetSize()-1, strTemp);
	}

	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102131380a80000000c770a82025800940408010601"));
	
	pos = m_strTrack2.Find(_T("="));
	strPart1 = m_strTrack2.Left( pos);
	strPart2 = m_strTrack2.Mid(pos+1);
	CString strPart22 = strPart2.Mid(7);

	strTemp = _T("");
	strTemp.Format(_T("send_apdu -sc 0 -APDU 00a401025d5d00b2010c005670545A08%s5F3401005F2403%s9F0702FF009F0D05F0502400009F0E0500008000009F0F05F0702498008E1200000000000000004201410342035E031F035F2503%s5F2802%s9F4A0182"), strPart1, m_strExpirationDate, m_strEffectiveDate, m_strCountry);
	sarray.Add(strTemp);

	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102323200b2020c002a70288c1e9f02069f03069f1a0295055f2a029a039c019f37049f35019f45029f34038d06910a0d8a029505"));
	
	strTemp = _T("");
	strTemp.Format(_T("send_apdu -sc 0 -APDU 00a401021c1c00b2030c001570139f080200025f3002%s9f4202%s9f440102"), m_strServiceCode, m_strCurrency);
	sarray.Add(strTemp);

	strTemp = _T("");
	strTemp.Format(_T("send_apdu -sc 0 -APDU 00a40102606000b2040c005970575713%sD%s5F2013202020202020202020202020202020202020209F1F1F313030303037313430303030303039383730303030303030303030303030309F2007%s0"), strPart1, strPart2, strPart22);
	
	if(!m_strCardFolderName.IsEmpty()) {
		ReplaceInfoEx(strTemp, _T("5F20"), m_strCardFolderName);	//HolderName
	}

	if(m_bTrack1Discr)
		ReplaceInfoEx(strTemp, _T("9F1F"), m_strTrack1/*strPart22*/);	//Track 1 Discretionary

	sarray.Add(strTemp);

	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102BDBD00b2050c00B67081B39381B00B41D3B830FAF294E4911DD1B5FF669085C998274E08248E60C9FBA29B9F029959F79105D9AC65A04B188DDDB26D0699014042AB783A94DDE7BD6978434289B6F6FA2685C272D63FEDBB0531D04AE2846B8CFB08F0C12BE9C51D62CFD6776B0EB9DE9BC890F303FEE81F22D1F7448CC25B826ED7A2A57C6E91A7161FD1DCF4F0DC17095F6159BDB43D0DD244FFD700647410A37E21CF174BFA439416831CEA8F1C3A9C93EECAD5A7B1E3F5949E2DC5AD"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102EAEA00b2060c00E37081E09081B0AB69F47BA64A4D4C08AB43848B66781F2B4DD1087FD368B768004A8295155048ED31BE277B1EE71E37E6D006937C087D074790774A4C29EE5AF7614FD829E39CE6D536D5BBD7490789C1BD563A1FC600FB031558E0970CCC58955D7DA03C37EA7D05184C46B9230FEE1C422FE88769AC63BD13BEF6B072B3FEE9264DC564FA173ADBEC2719EEC575A04778DA31A295C2E557540E0978C3FF3398C8D2C899FAB1F0F2F19414ECCF138C4C60ABD92148158F01059F3201039224CB98D378E88F7601643D0864748F276101E79E2886609B6ABF763DBDB120757E75B47327"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401020b0b80ca9f1700049f170103"));
	
	strTemp = _T("");
	strTemp.Format(_T("send_apdu -sc 0 -APDU 00a40102323280ae8000002B77299F2701809F360200499F2608%s9F10120114A500030200003B0F00000000000000FF"), m_strArqc1);
	sarray.Add(strTemp);
	
	strTemp = _T("");
	strTemp.Format(_T("send_apdu -sc 0 -APDU 00a40102323280ae4000002B77299F2701409F360200499F2608%s9F101201146500030200003B0F00000000000000FF"), m_strArqc2);
	sarray.Add(strTemp);
	
	strTemp = _T("");
	strTemp.Format(_T("send_apdu -sc 0 -APDU 00a40102323280ae0000002B77299F2701009F360200499F2608%s9F10120114A500030200003B0F00000000000000FF"), m_strArqc3);
	sarray.Add(strTemp);
	
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a4010209090020008000029000"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401020b0b80ca9f1700049f170103"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401060100"));
	sarray.Add(_T("card_disconnect"));
	sarray.Add(_T("release_context"));
	
	if (isGen == FALSE)
	{
		handleCommands(sarray);
		sarray.RemoveAll();
	}	
}

void CRM::MakeMasterScript02(CStringArray& sarray, BOOL isGen = FALSE)
{
	

	CString strTemp = _T("");
	CString strPart1, strPart2;
	int pos;

	//Make AutoRun (APDU command)
	sarray.Add(_T("mode_211"));
	sarray.Add(_T("establish_context"));
	sarray.Add(_T("enable_trace"));
	sarray.Add(_T("enable_timer"));
	sarray.Add(_T("card_connect"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a404000e315041592e5359532e4444463031"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401060100"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40101"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40105"));
	
	strTemp = _T("");
	strTemp.Format(_T("send_apdu -sc 0 -APDU 00a40102414100A4040007A00000000%s336F318407A00000000%sA526500A4D6173746572436172648701015F2D0670746573656E9F1101019F1207%s"), m_strAID, m_strAID, m_strPrefName);
	sarray.Add(strTemp);
	
	strTemp = sarray.GetAt(sarray.GetSize()-1);
	if(!m_strAppLabel.IsEmpty()) {
		ReplaceInfoEx(strTemp, _T("50"), m_strAppLabel);	//Application Label
		sarray.SetAt(sarray.GetSize()-1, strTemp);
	}
	
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102131380A80000000C770A82025800940408010601"));

	pos = m_strTrack2.Find(_T("="));
	strPart1 = m_strTrack2.Left( pos);
	strPart2 = m_strTrack2.Mid(pos+1);

	strTemp = _T("");
	strTemp.Format(_T("send_apdu -sc 0 -APDU 00a401025D5D00B2010C005670545A08%s5F2503%s5F3401005F2403%s9F0702FF009F0D05F050AC08009F0E0500108800009F0F05F070AC98008E1200000000000000004201410302031E031F035F2802%s9F4A0182"), strPart1, m_strEffectiveDate, m_strExpirationDate, m_strCountry);
	sarray.Add(strTemp);

	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102313100B2020C002A70288C1E9F02069F03069F1A0295055F2A029A039C019F37049F35019F45029F34038D06910A8A029505"));
	
	strTemp = _T("");
	strTemp.Format(_T("send_apdu -sc 0 -APDU 00a401021C1C00B2030C001570139F080200025F3002%s9F4202%s9F440102"), m_strServiceCode, m_strCurrency);
	sarray.Add(strTemp);

	strTemp = _T("");
	strTemp.Format(_T("send_apdu -sc 0 -APDU 00a40102545400B2040C004D704B5713%sD%s5F20186A6F7365206D617269616E6F2064612073696C76612073699F1F18393837363030303030303030303030353838303030303030"), strPart1, strPart2);
	
	if(!m_strCardFolderName.IsEmpty()) {
		ReplaceInfoEx(strTemp, _T("5F20"), m_strCardFolderName);	//HolderName
	}
	if(m_bTrack1Discr)
		ReplaceInfoEx(strTemp, _T("9F1F"), m_strTrack1/*strPart22*/);	//Track 1 Discretionary
	sarray.Add(strTemp);

	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102BDBD00B2050C00B67081B39381B0585701AB3D383A7D43BB1C067E03A7E8CDB5F069FFA1BABB57FB76D91387EEF587C7E4D2976564FF511110422CA1B68AEA1D6DD0452897B9F94540A6DBE020434BE9A416145480C5B59A74893269E1DF59F9A251985CF21D1F4E2367FA7C4768090FBC5C985818057F6D7F51F78EF0C0ED1B92E06E9376A21C837A7A23F7EB9B2F59EC7AC8E6D2CC89CC89D9E95CBFF1B95B22B45E4D729DCC314551E56A9457F919C7DB0411119F1D1A0E96ECD9F4FE"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102EAEA00B2060C00E37081E09081B043346B6855F28975EB6CDA546AD2DF2822DD1A404884EC7819EF9D422F45C7434A020E0B7F6F8E03B73DDFE1404A840FE99A32B27314CE05C460061EEABB6AD57B8A0682DA70CBFA17C7BAAA72CC4042189FC0D0629FCDB1315468F8EFC04FB90101572A271A5EAA40428A5C266B871E47AB432568EB8206AE3B379C5BBFD74CAE7C58B03BC3FDC4AC1FE5933FF5FD6ABBBA74BFBC9A78B01E3E0680B0A2D2D850187D86EE66F66CBBB39BA9B11A5A438F01059F32010392246FDC65F6FBFF12F50A1C99B9C76E7D6A3EDA0014B8B5C80D5D9CEC0051DA3DC091088371"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401020B0B80CA9F1700049F170103"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a4010209090020008000029000"));
	
	strTemp = _T("");
	strTemp.Format(_T("send_apdu -sc 0 -APDU 00a40102323280AE8000002B77299F2701809F360200459F2608%s9F10120210A50003020000213F00000000000000FF"), m_strArqc1);
	sarray.Add(strTemp);
	
	strTemp = _T("");
	strTemp.Format(_T("send_apdu -sc 0 -APDU 00a40102323280AE4000002B77299F2701409F360200459F2608%s9F10120210650003020000213F00000000000000FF"), m_strArqc2);
	sarray.Add(strTemp);
	
	strTemp = _T("");
	strTemp.Format(_T("send_apdu -sc 0 -APDU 00a40102323280AE0000002B77299F2701009F360200459F2608%s9F10120210A50003020000213F00000000000000FF"), m_strArqc3);
	sarray.Add(strTemp);
	
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401020b0b80CA9F1700049f170103"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401060100"));
	sarray.Add(_T("card_disconnect"));
	sarray.Add(_T("release_context"));

	if (isGen == FALSE)
	{
		handleCommands(sarray);
		sarray.RemoveAll();
	}
}

void CRM::MakeVisa2Script(CStringArray& sarray, BOOL isGen = FALSE)
{
	

	CString strTemp = _T("");
	CString strPart1, strPart2;
	int pos;

	//Make AutoRun (APDU command)
	sarray.Add(_T("mode_211"));
	sarray.Add(_T("establish_context"));
	sarray.Add(_T("enable_trace"));
	sarray.Add(_T("enable_timer"));
	sarray.Add(_T("card_connect"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a404000e315041592e5359532e4444463031"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401060100"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40101"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40105"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401023B3B00A404000E315041592E5359532E4444463031266F24840E315041592E5359532E4444463031A5128801015F2D087074656E657369749F110101"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401022D2D00B2010C0026702461224F07A0000000031010500A564953414352454449549F12074352454449544F870101"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102222200B2020C001B701961174F07F07600000352005009564953412043415348870102"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102090900B2030C00026A83"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102494900A4040007A00000000310103B6F398407A0000000031010A52E870101500A564953414352454449549F38039F1A025F2D087074656E657369749F1101019F12074352454449544F"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102171780A800000010800E5C00080103001001030210040602"));

	pos = m_strTrack2.Find(_T("="));
	strPart1 = m_strTrack2.Left( pos);
	strPart2 = m_strTrack2.Mid(pos+1);
	
	strTemp = _T("");
	strTemp.Format(_T("send_apdu -sc 0 -APDU 00a40102565600B2010C004F704D5713%sD%s5F201A6175746f72697a61646f20636f6d2073656e68612020202020209F1F1833303635372020202020202020303035323730303042525A"), strPart1, strPart2);
	
	if(!m_strCardFolderName.IsEmpty()) {
		ReplaceInfoEx(strTemp, _T("5F20"), m_strCardFolderName);	//HolderName
	}
	if(m_bTrack1Discr)
		ReplaceInfoEx(strTemp, _T("9F1F"), m_strTrack1/*strPart22*/);	//Track 1 Discretionary
	sarray.Add(strTemp);

	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401021C1C00B2020C001570139F0802008C5F300206019F420209869F440102"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102393900B2030C003270308C159F02069F03069F1A0295055F2A029A039C019F37048D178A029F02069F03069F1A0295055F2A029A039C019F3704"));

	strTemp = _T("");
	strTemp.Format(_T("send_apdu -sc 0 -APDU 00a40102171700B201140010700E5A08%s5F340100"), strPart1);
	sarray.Add(strTemp);

	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401021F1F00B20214001870165F24031801319F0702AB005F280200765F2503100607"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102CACA00B2031400C37081C08F01079081907F4E90D2CDF4578821B10127B109E2C39B12C9B5B0AF7190E2B2285146479BF3866879B774681EA53778F68D3CD683D67F68E2C6042DC0ECC0E001EF45C8FDE99000FE925927CA43FB94EDFB17DACE5F5F8640DD545811C6B13AE983CD4A5857FA21B5D03E14847B528AA9F3D7ABB96CEB846BABE424BE56DB8CCDA7961CC331AD61264D7A280A5E1D9C9297A8A4A7AD9F320103922433D0F87C92C8DFE9A5A401CB3F2F25377FDFF4E2E04610F29974D2C038A837FA7E1FC901"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102212100B20414001A70189F0D05D02804A8009F0E052850A800009F0F05D02814F800"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102272700B205140020701E8E1C0000000000000000010202011F001F001F001F001F001F001F001F00"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102A1A100B20614009A7081979F4A018293819042FBBD2D32AC2ACDA3B1E99FBABAAC2A022EEA4D974F44237BCA2C541E9A78A6A868C6FB0C34E1F13B452826A08DEE3B477C02CAFB83F54B79F742250F69938563E76B765F2183AC1C494A30D6B72855A0FEE9614E17BC574AA0503C5DBFA010C56A90563D8237C08F6C69F57B07BBEAA6A97398E59B0CAE9FA228BBDA7F876127F01986FA635D5A22855A4B5910CE15"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401020B0B80CA9F1700049F170103"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a4010209090020008000029000"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401021B1B80AE8000001480128001EF4980B68436958E5D06020A03A42000"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a4010209090082000000029000"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401021B1B80AE4000001480124001EFFB42F466022D9E1906020A03642000"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401021B1B80AE0000001400128001EF4980B68436958E5D06020A03A42000"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401020b0b80CA9F1700049f170103"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401060100"));
	sarray.Add(_T("card_disconnect"));
	sarray.Add(_T("release_context"));

	if (isGen == FALSE)
	{
		handleCommands(sarray);
		sarray.RemoveAll();
	}
}

void CRM::MakeXScript(CStringArray& sarray, BOOL isGen = FALSE)
{
	

	CString strTemp = _T("");
	CString strPart1, strPart2;
	int pos;

	//Make AutoRun (APDU command)
	sarray.Add(_T("establish_context"));
	sarray.Add(_T("enable_trace"));
	sarray.Add(_T("enable_timer"));
	sarray.Add(_T("card_connect"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a404000e315041592e5359532e4444463031"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401060100"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40101"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40105"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102414100A4040007A0000000041010336F318407A0000000041010A526500A4D6173746572436172648701015F2D0670746573656E9F1101019F12074372656469746F"));
	
	strTemp = sarray.GetAt(sarray.GetSize()-1);
	if(!m_strAppLabel.IsEmpty()) {
		ReplaceInfoEx(strTemp, _T("50"), m_strAppLabel);	//Application Label
		sarray.SetAt(sarray.GetSize()-1, strTemp);
	}

	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102131380A80000000C770A82025800940408010601"));

	pos = m_strTrack2.Find(_T("="));
	strPart1 = m_strTrack2.Left( pos);
	strPart2 = m_strTrack2.Mid(pos+1);

	strTemp = _T("");
	strTemp.Format(_T("send_apdu -sc 0 -APDU 00a401025D5D00B2010C005670545A08%s5F25031207055F3401005F24031801319F0702FF009F0D05F050AC08009F0E0500108800009F0F05F070AC98008E1200000000000000004201410302031E031F035F280200769F4A0182"), strPart1);
	sarray.Add(strTemp);

	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102313100B2020C002A70288C1E9F02069F03069F1A0295055F2A029A039C019F37049F35019F45029F34038D06910A8A029505"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401021C1C00B2030C001570139F080200025F300202019F420209869F440102"));

	strTemp = _T("");
	strTemp.Format(_T("send_apdu -sc 0 -APDU 00a40102545400B2040C004D704B5713%sD%s5F2018534F555A412F4D415243454C4F205245474953204C2044459F1F18393837363030303030303030303030373739303030303030"), strPart1, strPart2);
	
	if(!m_strCardFolderName.IsEmpty()) {
		ReplaceInfoEx(strTemp, _T("5F20"), m_strCardFolderName);	//HolderName
	}
	if(m_bTrack1Discr)
		ReplaceInfoEx(strTemp, _T("9F1F"), m_strTrack1/*strPart22*/);	//Track 1 Discretionary
	sarray.Add(strTemp);

	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401029D9D00B2050C00967081939381908E6D1122FEB6CBEBDF25AC2CB91F673E680D9040F12DB23AAD9A86786435AF5987D6463A2BD1F37528FA21B256DA2329132C5C9B6C430A17593D476D0CA8EDA1E54DCB32487EECBF7BD95B172EC0CF8055A2183664CF68CA198D66A57B01B7BFCAE64CFAC85FD4ADA4B7C44F40B2D2BD39690BEF13160F2400D91BD5EAA7321919B66AE0614110F5D2F23E51162CA734"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102CACA00B2060C00C37081C0908190A2607E5D47F3F58661B7CDE594CD6D0F5B731D6CEF5CF4F4056DC237DA3C8C4285A0E1104042974748B8770EBE1B0A380049824D7B95CBB83B1398E9BC7EBF95B8E8A6B14950308A77FDA2F19D142D32E20449F86590C5D7E6EC9873BA95C41AB5E124D06465F956FFCF819351E8902E24018F11F36878887C9C5E15563270DF80A6EE49DB4B9373E8D6F1AD8A453CCD8F01049F3201039224FD83306C42CDFA64151AE4E97AEB93B8F9B1BE7D76B89D5A2FFA2F222B18379FFA55BCCD"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401020B0B80CA9F1700049F170103"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a4010209090020008000029000"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102323280AE8000002B77299F2701809F360202739F2608323A5AC662D3F85C9F10120210A50003020000E4F600000000000000FF"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102323280AE4000002B77299F2701409F360202739F260832A525FA13734CA29F10120210650003020000E4F600000000000000FF"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102323280AE0000002B77299F2701009F360202739F2608323A5AC662D3F85C9F10120210A50003020000E4F600000000000000FF"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401020b0b80CA9F1700049f170103"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401060100"));
	sarray.Add(_T("card_disconnect"));
	sarray.Add(_T("release_context"));

	if (isGen == FALSE)
	{
		handleCommands(sarray);
		sarray.RemoveAll();
	}
}

// 15 digit !!!
void CRM::MakeAmexScript(CStringArray& sarray, BOOL isGen = FALSE)
{
	

	CString strTemp = _T("");
	CString strPart1, strPart2;
	int pos;

	//Make AutoRun (APDU command)
	sarray.Add(_T("establish_context"));
	sarray.Add(_T("enable_trace"));
	sarray.Add(_T("enable_timer"));
	sarray.Add(_T("card_connect"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a404000e315041592e5359532e4444463031"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401060100"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40101"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40105"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401023B3B00A404000E315041592E5359532E4444463031266F24840E315041592E5359532E4444463031A5128801015F2D087074656E657369749F110101"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102282800B2010C0021701F611D4F08A0000000250104025004414D45588701019F12074352454449544F"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102272700B2020C0020701E611C4F07A00000002910105004414D45588701029F12074352454449544F"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102090900B2030C00026A83"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401023F3F00A4040008A000000025010402306F2E8408A000000025010402A5225004414D45588701015F2D087074656E657369749F1101019F12074352454449544F"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102131380A80000000C800A5C000801040008050501"));

	pos = m_strTrack2.Find(_T("="));
	strPart1 = m_strTrack2.Left( pos);
	strPart2 = m_strTrack2.Mid(pos+1);

	strTemp = _T("");
	strTemp.Format(_T("send_apdu -sc 0 -APDU 00a40102424200B2010C003B70395F201A57494C44454252414E444F20522053414E544F532020202020205713%sD%s9F4A01828F010F"), strPart1, strPart2);
	
	if(!m_strCardFolderName.IsEmpty()) {
		ReplaceInfoEx(strTemp, _T("5F20"), m_strCardFolderName);	//HolderName
	}
	sarray.Add(strTemp);

	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102626200B2020C005B70599F080200015F300202018E180000000000000000420141035E031F0200000000000000008C159F02069F03069F1A0295055F2A029A039C019F37048D178A029F02069F03069F1A0295055F2A029A039C019F37049F42020986"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102E7E700B2030C00E07081DD9081B02B7E1D1F928CD5AD8B0238D62A2ED0CC8A2D220ACF2480394C53C7C3FD836896939B0D8AF26ADB33C98014E652BF6BCA50140D2F9A93D741CD3F0DF61007E631E145CB1E353FC11D72E93A66014B510F79757A1235CABA64AAE6755E6EFDFB31858505C276FC87EB64FDAF7F7F7CE9A3A312DDE17FD21470599209A3A821069512C09469BB7C36152739233FDE66A6E127E42BCCA1E479CADF0C307F4E107B57FE04BC372AFF5E7CF61B5753422149559224A366F3D42A654F00917CC08A02BC8F67A22D5D238294B5B295B9118F38AC111155D56FE19F320103"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102BDBD00B2040C00B67081B39381B092761445EA30FEA004E3B74902758044D4A6DD3EA1506ABA0A131562AEC1994C6EBBECD0A3B0E0DAA9C9F6FE9CDFD1AB82A91C22AADA7DA01F1522012E92B1D765B2181708EDF26C724A12A4CA5071A6B280505743BDA1590DD25D43A0813055ADF7A4AA4D67E997EB2A93A434DD011F0DDA39ED6E2241C8FEA734FEB0A389C335A4D3BFC7C02F2413320C18014DA8F59328FE4D17C2A8ADF7A105648D8BDA2A44FCEE7B084982AB4AA7C864DA3ECC1D"));

	strTemp = _T("");
	strTemp.Format(_T("send_apdu -sc 0 -APDU 00a40102454500B2050C003E703C5F25031405015F24031801185A08%sF5F3401019F0D05F050ECA0009F0E0500000000009F0F05F078FCF8005F280200769F0702FF00"), strPart1);
	sarray.Add(strTemp);

	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401020B0B80CA9F1700049F170103"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a4010209090020008000029000"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401021B1B80AE80000014801280001EF21B1BCA08114CD1065A0103A4B800"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401021B1B80AE40000014801240001ED0D11F2A4D019855065A010364BC00"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401021B1B80AE00000014001280001EF21B1BCA08114CD1065A0103A4B800"));
		sarray.Add(_T("send_apdu -sc 0 -APDU 00a401020b0b80CA9F1700049f170103"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401060100"));
	sarray.Add(_T("card_disconnect"));
	sarray.Add(_T("release_context"));

	handleCommands(sarray);
	sarray.RemoveAll();

	
}

void CRM::MakeDEBIT1Script(CStringArray& sarray, BOOL isGen = FALSE)
{
	

	CString strTemp = _T("");
	CString strPart1, strPart2;
	int pos;

	//Make AutoRun (APDU command)
	sarray.Add(_T("establish_context"));
	sarray.Add(_T("enable_trace"));
	sarray.Add(_T("enable_timer"));
	sarray.Add(_T("card_connect"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a404000e315041592e5359532e4444463031"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401060100"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40101"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40105"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102373700A404000E315041592E5359532E4444463031226F20840E315041592E5359532E4444463031A50E8801015F2D047074656E9F110101"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401022E2E00B2010C0027702561234F07A0000000032010500C56495341454C454354524F4E9F120644454249544F870101"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102090900B2020C00026A83"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102464600A4040007A0000000032010386F368407A0000000032010A52B500C56495341454C454354524F4E8701019F38039F1A025F2D047074656E9F1101019F120644454249544F"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102171780A800000010800E5C00080103001001030210040501"));

	pos = m_strTrack2.Find(_T("="));
	strPart1 = m_strTrack2.Left( pos);
	strPart2 = m_strTrack2.Mid(pos+1);
	
	strTemp = _T("");
	strTemp.Format(_T("send_apdu -sc 0 -APDU 00a40102555500B2010C004E704C5713%sD%s5F201A20202020202020202020202020202020202020202020202020209F1F173030303030303030303030303030333037303030303030"), strPart1, strPart2);
	
	if(!m_strCardFolderName.IsEmpty()) {
		ReplaceInfoEx(strTemp, _T("5F20"), m_strCardFolderName);	//HolderName
	}
	if(m_bTrack1Discr)
		ReplaceInfoEx(strTemp, _T("9F1F"), m_strTrack1/*strPart22*/);	//Track 1 Discretionary
	sarray.Add(strTemp);

	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401021C1C00B2020C001570139F0802008C5F300206209F420209869F440102"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102393900B2030C003270308C159F02069F03069F1A0295055F2A029A039C019F37048D178A029F02069F03069F1A0295055F2A029A039C019F3704"));

	strTemp = _T("");
	strTemp.Format(_T("send_apdu -sc 0 -APDU 00a40102171700B201140010700E5A08%s5F340100"), strPart1);
	sarray.Add(strTemp);

	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401021F1F00B20214001870165F24031803319F0702AB805F280200765F2503130124"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102EAEA00B2031400E37081E08F01089081B0D1AF08878EBC6D29864DF60F872B69DC10529C908D4D95962C7C34986B63AAEE104450FE551D08C5B203BCD3AEF6347276939CD4C06905EB1F7133E316E2C384C3EC2BFABC9CFE11A37BBB85DE44B022998D4DE52AF3DB410324E43AC462B004151F05CDE3A5F94F414384F2577F325E1D511B0426FA775DEF043A35158D18A888B051CA4AE8BEC6073C7F45D336BFC764295158D98042353D4127D50685939F7672BF16EAF9820F47D5DF3AD779A9819F3201039224EED794B9C72A28596DCB50B6B99D04FD1381DBC770CC859CEF7A97899665280204F848AF"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102353500B20414002E702C9F0E0520108800009F0F05D86834F8009F0D05D86024A8008E120000000000000000420102031E0300011F00"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102C1C100B2051400BA7081B79F4A01829381B01E31BB12CF4B3824ED7483C8C20C3368CDE63B2DC7BF50D494FB98BD004DE1A6EFD77FBB0DC0DF5165F9CFBD287EDC67C88982FD87E53A45D9AFBFCBD844582E31F1C06FC948327EB0D6A5242CB300283B313ACD3986565A9D6C258F40D56864FD7C3FE0FD67EDEF14EAD399487E717D93E286C5C2579B15DE7ABD2C1018E07A1B222BA8709F1538EDE771C27E7CD5677A2B02EE33A0602BAB0E8C8CE38376E9EFAF68A310704D839968E7D8028A46B0"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401021B1B80AE80000014801280014C847023D29DA9B49206010A03A0A800"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401021B1B80AE40000014801240014C9CDE25F7EF9F8C8006010A0360AC00"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401021B1B80AE00000014001280014C847023D29DA9B49206010A03A0A800"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a4010209090020008000029000"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401020b0b80CA9F1700049f170103"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401060100"));
	sarray.Add(_T("card_disconnect"));
	sarray.Add(_T("release_context"));

	if (isGen == FALSE)
	{
		handleCommands(sarray);
		sarray.RemoveAll();
	}
}

void CRM::MakeDEBIT2Script(CStringArray& sarray, BOOL isGen = FALSE)
{
	

	CString strTemp = _T("");
	CString strPart1, strPart2;
	int pos;

	/*
		# Trilha a converter: [6036890010458422235=21052201906906140]
		# 16 primeiros: [6036890010458422235 ]
		# Validade: [210531 ]
		# TIPO :  MASTER
		#
		#
		##
	*/
	//Make AutoRun (APDU command)
	sarray.Add(_T("establish_context"));
	sarray.Add(_T("enable_trace"));
	sarray.Add(_T("enable_timer"));
	sarray.Add(_T("card_connect"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a404000e315041592e5359532e4444463031"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401060100"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40101"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40105"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102393900A404000E315041592E5359532E4444463031246F22840E315041592E5359532E4444463031A5108801015F2D0670746573656E9F110101"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102292900B2010C00227020611E4F07A000000004306050074D61657374726F9F120644656269746F870101"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102090900B2020C00026A83"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102454500A4040007A0000000043060376F358407A0000000043060A52A50074D61657374726F8701015F2D0670746573656E9F1101019F120644656269746FBF0C059F4D020B0A"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102131380A80000000C770A82025800940410010401"));

	pos = m_strTrack2.Find(_T("="));
	strPart1 = m_strTrack2.Left( pos);
	strPart2 = m_strTrack2.Mid(pos+1);

	strTemp = _T("");
	strTemp.Format(_T("send_apdu -sc 0 -APDU 00a40102959500B20114008E70818B5F25031402125F24031801319F0702FFC05A0A%sF8E0C0000000000000000020301039F0D05F0501488009F0E050000A800009F0F05F0701498008C1E9F02069F03069F1A0295055F2A029A039C019F37049F35019F45029F34038D06910A8A0295055F3401009F4A01829F4401029F420209865F300202209F080200025F28020076"), strPart1);
	sarray.Add(strTemp);

	strTemp = _T("");
	strTemp.Format(_T("send_apdu -sc 0 -APDU 00a40102F1F100B2021400EA7081E75713%sD%s5F2019415249414C444F20504149564120444F5320524549532020209381B09FB203B16193BF47782EDBE27512DDE0BD143FA1BED544DEB9D786838C823FD9409343937105468ABB419DCC07E36E7687979EA5CEB2677D3B8FB99EE9E98ABD3136D24AB21EF7AC532E72E9C03CA19A6886F30D608F04688569200C4C0E06304402A1ED05C563ABFA4A0A3626337F6CA6EE922FCB4AB86F3242448143BCFB4C240FE668B0000EC948994E2252C2577A5AB939D922F2AEA88B06D096F836AD645D7F9428BF2B4792AC3AE0164DCDC49D8F0105"), strPart1, strPart2);
	
	if(!m_strCardFolderName.IsEmpty()) {
		ReplaceInfoEx(strTemp, _T("5F20"), m_strCardFolderName);	//HolderName
	}
	sarray.Add(strTemp);

	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102BDBD00B2031400B67081B39081B07584BD72F50D6A4F68E64C77DEBC625AF9722FA89CE14C9D74A7CDC8C5B99F77FAD68049F270F3766451F29C900837810DA9103EEDD57AE635641695195298151481E43CA45724A7CCA5A66FDEC5EACB8F2A96EEEF6AF8C95FA4F8F46C8A92224139B09140982E74F3F9B3AA41EC96805D399C085BA97B2D891E9FE1FF2FF6EB65F13419617E40081DF27F43634C3F6E3F4DB7742C806A606CC8F36ABBA9672153F49F9829E95B4E5DACD00EFF83F1FC"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102333300B20414002C702A9F3201039224D845B19B0B04A14934A6AE9971CC83378E297E25E126FBD8EB4C6DD46DCCED9C057A31A3"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102323280AE8000002B77299F2701809F360200C39F26084DE14BFC2F73BAC49F10120210A00003220000DD2500000000000000FF"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102323280AE4000002B77299F2701409F360200C39F26082E3DFFB8DA4363C59F10120210600003220000DD2500000000000000FF"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a40102323280AE0000002B77299F2701009F360200C39F26084DE14BFC2F73BAC49F10120210A00003220000DD2500000000000000FF"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a4010209090020008000029000"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401020b0b80CA9F1700049f170103"));
	sarray.Add(_T("send_apdu -sc 0 -APDU 00a401060100"));
	sarray.Add(_T("card_disconnect"));
	sarray.Add(_T("release_context"));

	if (isGen == FALSE)
	{
		handleCommands(sarray);
		sarray.RemoveAll();
	}
	
}

void CRM::Format()
{
	CStringArray arr;

#if 1	//original code
	//MakeCommonSubScript(arr, 0);	//Erase
	MakeCommonSubScript(arr, 1);	//Erase (EVM)
	MakeCommonSubScript(arr, 4);	//Install Applet (EVM)
	//MakeCommonSubScript(arr, 4);	//Install Applet (EVM)
#endif

#if 0
	MakeCommonSubScript(arr, 1);	//trace
	MakeCommonSubScript(arr, 5);	//install
#endif
}

void CRM::Burn(int nCategory, CStringArray& ar, BOOL isGen = FALSE)
{
	
	switch(nCategory) {
		case 0:	//MASTERCARD
			MakeMasterScript01(ar, isGen);
			break;
		case 1:	//MASTERCARD 2
			MakeMasterScript02(ar, isGen);
			break;
		case 2:	//AMEX
			MakeAmexScript(ar, isGen);
			break;
		case 3:	//X
			MakeXScript(ar, isGen);
			break;
		case 4:	//VISA2
			MakeVisa2Script(ar, isGen);
			break;
	}

	
}

void CRM::Debit(int nCategory, CStringArray& ar, BOOL isGen = FALSE)
{

	switch(nCategory) {
		case 0:	//DEBIT 1
			MakeDEBIT1Script(ar, isGen);
			break;
		case 1:	//DEBIT 2
			MakeDEBIT2Script(ar, isGen);
			break;
		case 2:	//6036
			break;
	}

	
}

CString CRM::GetTrack1_01()
{
	return _T("31303030303731343030303030303938373030303030303030303030303030");
}

CString CRM::GetTrack1_02()
{
	return _T("393837363030303030303030303030353838303030303030");
}

CString CRM::GetTrack1_03()
{
	return _T("");
}

CString CRM::GetTrack1_04()
{
	return _T("393837363030303030303030303030373739303030303030");
}

CString CRM::GetTrack1_05()
{
	return _T("33303635372020202020202020303035323730303042525A");
}

CString CRM::GetTrack1_06()
{
	return _T("3030303030303030303030303030333037303030303030");
}

CString CRM::GetTrack1_07()
{
	return _T("");
}

CString CRM::GetTrack1Info(int nCategory)
{
	switch(nCategory) {
		case 0:	//MASTERCARD
			m_strTrack1 = GetTrack1_01();
			break;
		case 1:	//MASTERCARD 2
			m_strTrack1 = GetTrack1_02();
			break;
		case 2:	//AMEX
			m_strTrack1 = GetTrack1_03();
			break;
		case 3:	//X
			m_strTrack1 = GetTrack1_04();
			break;
		case 4:	//VISA2
			m_strTrack1 = GetTrack1_05();
			break;
		
		//DEBIT
		case 5:	//X
			m_strTrack1 = GetTrack1_06();
			break;
		case 6:	//VISA2
			m_strTrack1 = GetTrack1_07();
			break;
		default:
			m_strTrack1 = _T("");
			break;
	}

	if( !m_strTrack1.IsEmpty()) {
		char pAscii[64] = {0,};
		ConvertHexStringToBytes((char*)(LPCTSTR)m_strTrack1,(BYTE*)pAscii);

		m_strTrack1.Format(_T("%s"),pAscii);
	}

	return m_strTrack1;
}

int CRM::GetTrack2Info(int nCategory, CString& strFiled1, CString& strField2)
{
	int nLength = 0x13;

	if(nCategory == 2)	{//AMEX
		strFiled1 = _T("aaaaaaaaaaaaaaa");			//15
		strField2 = _T("bbbbbbbbbbbbbbbbbbbbbb");	//22
	}
	else {
		strFiled1 = _T("aaaaaaaaaaaaaaaa");			//16
		strField2 = _T("bbbbbbbbbbbbbbbbbbbbb");	//21
	}

	return nLength;
}
